{
  "hash": "3f4f7067f2091c16d2a035ef55877d04",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 如何绘制在甜甜圈图中添加注释\ncategory: \"ggplot2\"\n---\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\ntheme_set(hrbrthemes::theme_ipsum_rc())\n\ndt <- tibble(\n  type = sample(c(\"A\", \"B\", \"C\", \"D\"), size = 100, replace = TRUE, prob = c(0.3, 0.4, 0.2, 0.1))\n  ) %>% \n  # 设置因子的排序\n  mutate(type = factor(type, c(\"D\", \"A\", \"C\", \"B\"))) %>% \n  count(type) %>% \n  mutate(prop = n / sum(n))\n```\n:::\n\n\n甜甜圈图和扇形图常用来刻画各部分在整体中的占比，`ggplot2`的`coord_radial`绘制甜甜圈图非常方便。甜甜圈图中是通过角度来表示大小，而人眼不擅长比较角度的大小。从下面可以清楚的看出这一点：\n\n\n::: {#fig-对比 .cell layout-ncol=\"2\" layout-align=\"center\"}\n\n```{.r .cell-code}\ndt %>% \n  ggplot(aes(x = type, y = prop, fill = type)) +\n  geom_col(show.legend = FALSE)\n\ndt %>% \n  ggplot(aes(y = factor(1), x = prop, fill = type)) +\n  geom_col() +\n  coord_radial(expand = FALSE, inner.radius = 0.4) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![条形图](甜甜圈图_files/figure-html/fig-对比-1.png){#fig-对比-1 fig-align='center' width=672}\n:::\n\n::: {.cell-output-display}\n![甜甜圈图](甜甜圈图_files/figure-html/fig-对比-2.png){#fig-对比-2 fig-align='center' width=672}\n:::\n\n甜甜圈图 vs 条形图\n:::\n\n\n@fig-对比-1 中可以从柱子的高度中看出A所占的比重大于B，@fig-对比-2 中则很难看出A和B谁占的比重大。\n\n所以甜甜圈图和扇形图需要加上注释，表明各部分的占比，加注释需要提供注释的位置，一般大家都希望把注释放在扇形的中间，怎么确定每个扇形中间的位置呢？先了解以下`coord_radial()`的原理。\n\n\n::: {#fig-coord_radial的原理 .cell layout-ncol=\"2\" layout-align=\"center\"}\n\n```{.r .cell-code}\np <- dt %>% \n  ggplot(aes(y = factor(1), x = prop, fill = type)) +\n  geom_col() +\n  theme_void()\n\np\np + \n  coord_radial(theta = \"x\",\n               expand = FALSE)\n```\n\n::: {.cell-output-display}\n![普通柱状图](甜甜圈图_files/figure-html/fig-coord_radial的原理-1.png){#fig-coord_radial的原理-1 fig-align='center' width=672}\n:::\n\n::: {.cell-output-display}\n![coord_radial](甜甜圈图_files/figure-html/fig-coord_radial的原理-2.png){#fig-coord_radial的原理-2 fig-align='center' width=672}\n:::\n\ncoord_radial的原理\n:::\n\n\n`coord_radial`就是将某条坐标轴卷起来，将 @fig-coord_radial的原理-1 沿着x轴卷起来就得到了 @fig-coord_radial的原理-2 。\n\n所以要确定扇形中间的位置，只需要确定 @fig-coord_radial的原理-1 中每个颜色区间的中点，而颜色区间的中点等于该颜色区间两个端点相加除以二，所以我们只需要确定每个颜色区间端点的位置。\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![区间端点的位置](甜甜圈图_files/figure-html/fig-区间端点的位置-1.png){#fig-区间端点的位置 fig-align='center' width=672}\n:::\n:::\n\n\n区间的端点由每种因子所占的比重依次相加得到，而注释的横坐标就是区间的中点。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_plot <- dt %>% \n  # 先按因子变量将数据倒序排列，因为ggplot默认倒序\n  arrange(desc(type)) %>% \n  mutate(\n    # 将占比依次相加得到区间端点\n    cum_prop = cumsum(prop),\n    # 计算区间的中点\n    mid = slider::slide_dbl(cum_prop, mean, .before = 1, .complete = TRUE),\n    mid = if_else(is.na(mid), cum_prop/2, mid)\n  )\ndt_plot\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n  type      n  prop cum_prop   mid\n  <fct> <int> <dbl>    <dbl> <dbl>\n1 B        33  0.33     0.33 0.165\n2 C        19  0.19     0.52 0.425\n3 A        42  0.42     0.94 0.73 \n4 D         6  0.06     1    0.97 \n```\n\n\n:::\n:::\n\n\n最后将注释放在区间的中点即可。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_plot %>% \n  ggplot(aes(y = factor(1), x = prop, fill = type)) +\n  geom_col(show.legend = FALSE) +\n  geom_text(aes(label = prop, x = mid, y = 1), fontface = \"bold\") +\n  geom_text(aes(x = mid, y = 1.6, label = type)) +\n  scale_x_continuous(breaks = c(0, ddd$cum_prop)) +\n  coord_radial(expand = FALSE, inner.radius = 0.4) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](甜甜圈图_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=672}\n:::\n:::\n",
    "supporting": [
      "甜甜圈图_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}